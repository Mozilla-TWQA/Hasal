<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Ejenti Dashboard - Build Information</title>

    <!-- Bootstrap Core CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/startbootstrap-sb-admin-2/3.3.7+1/css/sb-admin-2.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- Local Common JS/CSS Library by Walter -->
    <link href="css\build_info.css" rel="stylesheet" type="text/css">
    <script src="js\common.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.js"></script>

    <!-- DataTables JavaScript -->
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.0/js/dataTables.responsive.min.js"></script>

    <!-- Localforage : Caching downloaded data-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.4.0/localforage.min.js"></script>
    <script src="js\cachedFetch.js"></script>

    <script>
        // get build name
        var build_id = get_request("build");
        console.log(page + ": acquire build id - " + build_id);
        // get build archive
        var build_archive = get_request("date");
        console.log(page + ": acquire build id - " + build_archive);
    </script>
</head>

<body>
    <div id="title">Build Information</div>

    <div class="alert alert-success" style="font-size:18px; width: 80%; margin:0px auto;">
        <ul>
            <li>Build Hash: <label><script>document.write(build_id);</script></label></li>
            <li>Build Archive: <label><script>document.write(build_archive);</script></label></li> 
        </ul>
    </div>
    <br/>

    <div class="panel panel-info" style="width: 80%; margin:0px auto;">
        <div class="panel-body">
            <!-- Main Table -->
            <table id="dataTables" class="table table-bordered table-hover" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th></th>
                        <th>Agent</th>
                        <th>Task UID</th>
                        <th>Test Cases</th>
                        <th>Status</th>
                        <th>Description</th>
                        <th>Latest Update</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
    <br />

    <!-- Refresh Time -->
    <div class="col-lg-3.5" style="float: right; margin-right:9.2%;">
        <div class="panel panel-primary">
            <div class="panel-heading">
                 <i class="fa fa-refresh fa-fw"></i> Page Refreshed Time: <label><script>document.write(new Date());</script></label><br />
                 <i class="fa fa-clock-o fa-fw"></i> Data Acquired Time: <label id="data_acquired_time"></label> <br />
            </div>
            <!-- /.panel-heading -->
        </div>
    </div>

    <script>
        $('body').block( {  
            message : '<h1> Loading Data from Remote ... </h1>',
            css : {  
                border: 'none',
                padding: '15px',
                backgroundColor: '#000',
                '-webkit-border-radius': '10px',
                '-moz-border-radius': '10px',
                opacity: .5,
                color: '#fff',
                position: 'fixed',
                margin: 'auto'
            },
            centerY: false,
            centerX: false
        });
    </script>

    <script>
        var build_list = [];
        var tuid = {};
        var uid_to_status_info = {};

        // Load Cached Data : Agents List
        var current_timestamp = Date.now();
        // var agents_list_url = "https://gist.githubusercontent.com/mozhasalstatus/cf4b97a3273e2f3117211a3663928133/raw/file_name_list.json?" + parseInt(current_timestamp/500000);
        var agents_list_url = "https://gist.githubusercontent.com/mozhasalstatus/23c1d64642e5838900c01a3ccbbaee7c/raw/file_name_list.json?" + parseInt(current_timestamp/500000);
        var cached_agents_list = cachedFetch(agents_list_url);
        var data_acquired_time = getCachedTime(agents_list_url);
        var pulse_trigger_url = "https://gist.githubusercontent.com/mozhasalbuildstatus/24b3b2362138a71a6c3e3d0aedcb5f9a/raw/w10-hp-r1-1_recently.json?" + parseInt(current_timestamp/500000);
        var pulse_trigger = cachedFetch(pulse_trigger_url);

        // Wait for document loaded and set data acquired time
        $(document).ready(function() {
            data_acquired_time.then(function(timestamp){
                document.getElementById("data_acquired_time").innerText = new Date(timestamp);
            });
        });

        // wait till fully fetched pulse trigger data and agent data
        pulse_trigger.then(function(pulse_data) {
            console.log(page + ": got cached pulse trigger data for processing");


            cached_agents_list.then(function(input) {
                console.log(page + ": finished loading the agents list");
                var agents_list = Object.keys(input);

                // Started to acquire all agent data
                var agents_obj_list = new Array(agents_list.length);
                for(var i = 0; i < agents_list.length; i++) {
                    agents_obj_list[i] = cachedFetch(input[agents_list[i]]["recently"]["raw_url"] + "?" + parseInt(current_timestamp/500000));
                }

                Promise.all(agents_obj_list).then(function(agent_data_objs) {
                    console.log(page + ": got cached agent data for processing");

                    // BEGIN handling agent data
                    // Merge all the agents' data
                    console.log(page + ": start handling agent data");
                    var agent_data = []
                    for(let i = 0; i < agent_data_objs.length; i++) {
                        for(let j = 0; j < agent_data_objs[i].data.length; j++) {
                            agent_data_objs[i].data[j]['agent'] = agents_list[i];
                        }
                        agent_data = agent_data.concat(agent_data_objs[i].data);
                    }

                    // lookup dict for task uid
                    for(var i = 0; i < agent_data.length; i++) {
                        set = agent_data[i];
                        for (var j = 0; j < set.status.length; j++) {
                            stat = set.status[j];
                            if(("task_uid" in stat)) {
                                tuid[set.start_ts] = {};
                                tuid[set.start_ts][set.type] = stat.task_uid;
                            }
                        }
                    }

                    var latest_agent_status = jQuery.map(agent_data, function(agent_dt, i) {
                        let return_array = [];

                        // get task uid
                        var task_uid = ""
                        if (agent_dt.start_ts in tuid) {
                            task_uid = tuid[agent_dt.start_ts][agent_dt.type];
                        } else {
                            return [];
                        }

                        // TODO: need to put a note on format later
                        function _push_data() {
                            // This the format of data inside the table
                            
                            table_data = [agent_dt.type, agent_dt.cmd, agent_dt.start_ts,
                                          current_case, current_ts, (new Date(current_ts*1000).toUTCString()),
                                          current_status_desc, current_status, task_uid, agent_dt.status,
                                          agent_dt.agent];
                            if (! (task_uid in uid_to_status_info)) {
                                uid_to_status_info[task_uid] = [];
                            }
                            uid_to_status_info[task_uid].push(table_data);
                            return_array.push(table_data);
                            return table_data;
                        }

                        function _reset_variables() {
                            current_case = "";
                            current_status = -1;
                            current_status_desc = "";
                            current_ts = -1;
                        }

                        // TODO: might need to check if multiple status exists
                        var current_case = "";
                        var current_status = -1;
                        var current_status_desc = "";
                        var current_ts = -1;
                        agent_dt.status.sort((a, b) => (a.utc_timestamp > b.utc_timestamp) ? -1 : 1);
                        for (var i = 0; i < agent_dt.status.length; i++) {
                            status_data = agent_dt.status[i];
                            if ((status_data.utc_timestamp > current_ts) ||
                                   ((status_data.utc_timestamp == current_ts)&&(status_data.code > current_status))) {
                                current_status = status_data.code;
                                current_status_desc = status_data.status_code_desc;
                                current_ts = status_data.utc_timestamp;
                            }
                            if("case_name" in status_data) {
                                current_case = status_data["case_name"];
                            }
                        }

                        if (current_ts != (-1)) {
                            _push_data();
                            _reset_variables();
                        }

                        return return_array;
                    });
                    // END handling agent data

                    // BEGIN handling pulse trigger data
                    console.log(page + ": start handling pulse data");
                    var latest_trigger_status = jQuery.map(pulse_data.data, function(trigger_dt, i) {
                        // get latest status of each set of status
                        var latest_status = trigger_dt.status.getMax("utc_timestamp");

                        // get build information and cases list
                        var build_info = "";
                        var case_list = [];
                        if ("cmd_config" in latest_status) {
                            if ("DOWNLOAD_REVISION" in latest_status["cmd_config"]) {
                                // filter based on input revision
                                // if build hash is not assigned, all information in the file will be listed.
                                // otherwise, only matching build hash can be processed
                                // build_info = latest_status["cmd_config"]["DOWNLOAD_REVISION"];
                                if (typeof build_id == 'undefined') {
                                    build_info = latest_status["cmd_config"]["DOWNLOAD_REVISION"];
                                } else if (build_id == latest_status["cmd_config"]["DOWNLOAD_REVISION"]) {
                                    build_info = latest_status["cmd_config"]["DOWNLOAD_REVISION"];
                                } else {
                                    return [];
                                }
                            }
                            if ("OVERWRITE_HASAL_SUITE_CASE_LIST" in latest_status["cmd_config"]) {
                                case_list = latest_status["cmd_config"]["OVERWRITE_HASAL_SUITE_CASE_LIST"];
                            }
                        } else {
                            return [];
                        }

                        // separate by UID
                        let return_array = [];
                        function sort_function(a, b) {
                            if(a[4] == b[4]) {
                                return 0;
                            } else {
                                return (a[4] < b[4]) ? -1 : 1;
                            }
                        }
                        if (("task_uid_list" in latest_status) && (build_info != "")) {
                            let uid_list = latest_status.task_uid_list;
                            let uid_split = uid_list[0].split(".");
                            let test_case = uid_split[uid_split.length - 2];
                            for (var i = 0; i < uid_list.length; i++) {
                                // build up the table rows
                                let agent_name = "";
                                let latest_update_time = "";
                                if(uid_list[i] in uid_to_status_info) {
                                    let agent_status_info = uid_to_status_info[uid_list[i]];
                                    agent_name = agent_status_info[0][10];
                                    agent_status_info.sort(sort_function);
                                    latest_update_time = (new Date(parseInt(agent_status_info[agent_status_info.length-1][4])*1000).toUTCString());
                                }
                                let table_data = ["", agent_name, uid_list[i], test_case, latest_update_time, latest_status.status_code_desc, "["+latest_status.code+"]"];
                                return_array.push(table_data);
                            }
                        }

                        return return_array;
                    });
                    // END handling trigger data

                    // Table: wait till document ready and start to construct table
                    $(document).ready(function() {

                        // Entry point of building table
                        var table = $('#dataTables').DataTable({
                            "aaData": latest_trigger_status,
                            "aoColumns": [
                                 {
                                     "className":      "details-control",
                                     "orderable":      false,
                                     "data":           null,
                                     "defaultContent": '<i class="fa fa-hand-o-right fa-fw fa-1x" style="text-align:center;"></i>'
                                 },
                                 { "sTitle": "Agent" },
                                 { "sTitle": "Task UID" },
                                 { "sTitle": "Test Cases" },
                                 { "sTitle": "Latest Updated Time"},
                                 { "sTitle": "Status Description"},
                                 { "sTitle": "Status"}
                            ],
                            "order": [[ 2, "desc" ]]
                        });

                        // Disabled Jquery blockUI
                        $.unblockUI();

                        // Add event listener for opening and closing details
                        $('tbody').on('click', 'td.details-control', function () {
                            var tr = $(this).closest('tr');
                            var row = table.row( tr );
                            let task_uid = row.data()[2];
                            let task_uid_hash = task_uid.hashCode();
                            console.log(task_uid_hash);

                            if ( row.child.isShown() ) {
                                // This row is already open - close it
                                row.child.hide();
                                tr.removeClass('shown');
                            } else {
                                // Open detailed data for selected column
                                console.log(page + ": show selected column")
                                row.child( format( row.data() ) ).show();
                                fill_data(row.data());
                            }

                            $('#detailedTable' + task_uid_hash + ' tbody').on('click', '.more', function () {
                                console.log(page + ": getting detailed status from data in the row");
                                detailed_status = table2.row($(this).parent()).data()[9];

                                // open a popup window
                                console.log(page + ": open a popup window for status to be output");
                                var win = window.open("statusInfo", "statusInfo", "width=600, height=400");
                                var doc = win.document;
                                doc.open("application/json");

                                // sort by time first and then sort by status code
                                console.log(page + ": sort the status before output it");
                                ordered_status = detailed_status.slice(0);
                                ordered_status.sort(function(a, b) { 
                                    // if time is the same, sort by status code
                                    if (b.utc_timestamp == a.utc_timestamp) {
                                        return b.code - a.code;
                                    } else {
                                        return b.utc_timestamp - a.utc_timestamp;
                                    }
                                });

                                // out put the status in JSON format with indent 4
                                doc.write(JSON.stringify(ordered_status, null, 4));
                                doc.close();
                                win.focus();
                            });
                        });

                        // Subarea: fill detailed data
                        let table2;
                        function fill_data (input_column) {
                            let task_uid = input_column[2];
                            let task_uid_hash = task_uid.hashCode();

                            table2 = $('#detailedTable' + task_uid_hash).DataTable({
                                "aaData": uid_to_status_info[task_uid],
                                "aoColumns": [
                                     { "sTitle": "Type" },
                                     { "sTitle": "Command" },
                                     { "sTitle": "Start Timestamp", "bVisible": false },
                                     { "sTitle": "Test Case" },
                                     { "sTitle": "Latest Timestamp", "bVisible": false },
                                     { "sTitle": "Latest Updated Time" },
                                     { "sTitle": "Status Description", "sClass": "more" },
                                     { "sTitle": "Status"},
                                     { "sTitle": "Uid", "bVisible": false},
                                     { "sTitle": "Agent Name", "bVisible": false}
                                ],
                                "order": [[ 5, "desc" ]],
                                "autoWidth": false,
                                "bFilter": false,
                                "paging": false,
                                "info": false
                            });

                            return true;
                        };

                        // Subarea: Detailed datatable
                        function format (input_column) {
                            let task_uid = input_column[2];
                            let task_uid_hash = task_uid.hashCode();

                            detailed_table = '<table id="detailedTable' + task_uid_hash + '" name="detailedTable" class="table table-bordered table-hover" cellspacing="0" width="100%"><thead><tr>' +
                                             '<th></th> <th></th> <th></th> <th></th> <th></th>' +
                                             '<th></th> <th></th> <th></th> <th></th>' +
                                             '</tr></thead></table>';

                            // return created information area
                            return '<div class="shown_table"><br/>' + detailed_table + '</div>';
                        };

                    });


                });


            });

        });

    </script>


</body>

</html>
